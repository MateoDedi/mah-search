<%- include('partials/header'); -%>

    <% if (job) { %>
        <% if (updateJob) { %>
            <section>
                <form action="/job/update/<%= job._id %>" method="PUT" enctype="multipart/form-data">
                    <h2>Update</h2>

                    <label for="jobTitle">Job title</label>
                    <input type="text" name="jobTitle" value="<%= job.jobTitle %>" required>
                    <div class="jobTitle error"></div>

                    <label for="company">Company</label>
                    <input type="text" name="company" value="<%= job.company %>" required>
                    <div class="company error"></div>

                    <label for="website">Website</label>
                    <input type="text" name="website" value="<%= job.website %>" required>
                    <div class="website error"></div>

                    <h3>Employer's contact</h3>

                    <label for="name">Name</label>
                    <input type="text" name="name" value="<%= job.name %>">

                    <label for="email">Email of contact</label>
                    <input type="text" name="email" value="<%= job.email %>">
                    <div class="email error"></div>

                    <label for="phone">Phone</label>
                    <input type="text" name="phone" value="<%= job.phone %>">

                    <label for="address">Address</label>
                    <input type="text" name="address" value="<%= job.address %>">

                    <label for="origin">Origin</label>
                    <select name="origin" id="origin" required>
                        <option value="spontaneous">Spontaneous application</option>
                        <option value="job offer">Job offer</option>
                    </select>
                    <div class="origin error"></div>

                    <label for="status">Status</label>
                    <select name="status" id="status" required>
                        <option value="interested">Interested</option>
                        <option value="cv sent">CV sent</option>
                        <option value="negative">Negative</option>
                        <option value="interview">Interview</option>
                    </select>
                    <div class="status error"></div>

                    <label for="comments">Comments</label>
                    <textarea name="comments" id="comments" cols="30" rows="10"><%= job.comments %></textarea>

                    <button class="update" type="submit">Save</button>
                </form>
            </section>
            <% } else { %>
                <section>
                    <h2>
                        <%= job.jobTitle %>
                    </h2>
                    <h3>
                        <%= job.company %>
                    </h3>
                    <p>
                        <%= job.website %>
                    </p>
                    <p>
                        <%= job.name %>
                    </p>
                    <p>
                        <%= job.email %>
                    </p>
                    <p>
                        <%= job.phone %>
                    </p>
                    <p>
                        <%= job.address %>
                    </p>
                    <p>
                        <%= job.origin %>
                    </p>
                    <p>
                        <%= job.statusJob %>
                    </p>
                    <p>
                        <%= job.comments %>
                    </p>

                    <!-- <button class="btnD" type="submit" data-jobid="<%= job._id %>">Delete</button> -->
                    <!-- <button class="btnD" type="button" data-jobid="<%= job._id %>">Delete</button> -->


                    <a href="/job/update/<%= job._id %>">Edit</a>
                </section>
                <% } %>
                    <% } %>

                        <%- include('partials/footer'); -%>

                            <script>
                                // update job by try fetch

                                const form = document.querySelector('form');
                                const jobTitleError = document.querySelector('.jobTitle.error');
                                const companyError = document.querySelector('.company.error');
                                const websiteError = document.querySelector('.website.error');
                                const emailError = document.querySelector('.email.error');
                                const originError = document.querySelector('.origin.error');
                                const statusError = document.querySelector('.status.error');
                                const updateBtn = document.querySelector('.update');

                                document.addEventListener('submit', async (e) => {
                                    e.preventDefault();

                                    // reset errors
                                    jobTitleError.textContent = '';
                                    companyError.textContent = '';
                                    websiteError.textContent = '';
                                    emailError.textContent = '';
                                    originError.textContent = '';
                                    statusError.textContent = '';

                                    // get values
                                    const jobTitle = form.jobTitle.value;
                                    const company = form.company.value;
                                    const website = form.website.value;
                                    const name = form.name.value;
                                    const email = form.email.value;
                                    const phone = form.phone.value;
                                    const address = form.address.value;
                                    const origin = form.origin.value;
                                    const status = form.status.value;
                                    const comments = form.comments.value;



                                    const emailRegex = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;

                                    if (!emailRegex.test(email)) {
                                        emailError.textContent = 'Email is not valid';
                                    }
                                    if (jobTitle === '') {
                                        jobTitleError.textContent = 'Job title is required';
                                    }
                                    if (company === '') {
                                        companyError.textContent = 'Company is required';
                                    }
                                    if (website === '') {
                                        websiteError.textContent = 'Website is required';
                                    }
                                    if (origin === '') {
                                        originError.textContent = 'Origin is required';
                                    }
                                    if (status === '') {
                                        statusError.textContent = 'Status is required';
                                    }

                                    else {
                                        let infoJobs = {
                                            jobTitle,
                                            company,
                                            website,
                                            name,
                                            email,
                                            phone,
                                            address,
                                            origin,
                                            status,
                                            comments
                                        }
                                        try {
                                            const res = await fetch(`/job/update/${job._id}`, {
                                                method: 'PUT',
                                                body: JSON.stringify(infoUsers),
                                                headers: { 'Content-Type': 'application/json' }
                                            });
                                            const data = await res.json();
                                            console.log(data);
                                            if (data.errors) {
                                                jobTitleError.textContent = data.errors.jobTitle;
                                                companyError.textContent = data.errors.company;
                                                websiteError.textContent = data.errors.website;
                                                emailError.textContent = data.errors.email;
                                                originError.textContent = data.errors.origin;
                                                statusError.textContent = data.errors.status;
                                            }
                                            if (data.user) {
                                                location.assign(`/job/update/${job._id}`);
                                            }

                                        }
                                        catch (err) {
                                            console.log(err);
                                        }
                                    }

                                });

                                // // // delete job
                                // const deleteBtn = document.querySelectorAll('.btnD');
                                // deleteBtn.addEventListener('click', () => {
                                //     console.log('delete');
                                // });
                                // // document.addEventListener('DOMContentLoaded', () => {
                                // //     const deleteBtn = document.querySelector('.btnD');
                                // //     deleteBtn.addEventListener('click', async (e) => {
                                // //         const jobId = e.target.dataset.jobid;
                                // //         const confirmation = confirm("Are you sure you want to delete this job?");

                                // //         if (confirmation) {
                                // //             try {
                                // //                 const response = await fetch(`/job/delete/${jobId}`, {
                                // //                     method: 'DELETE',
                                // //                     body: JSON.stringify({ _id: jobId }),
                                // //                     headers: {
                                // //                         'Content-Type': 'application/json'
                                // //                     }
                                // //                 });

                                // //                 const data = await response.json();
                                // //                 console.log(data);

                                // //                 if (data.success) {
                                // //                     // Rediriger vers la page '/list-jobs' après la suppression réussie
                                // //                     window.location.href = '/list-jobs';
                                // //                 }
                                // //             } catch (error) {
                                // //                 console.error('Error deleting job:', error);
                                // //             }
                                // //         }
                                // //     });
                                // // });








                                <script />